```mermaid
# 1. 加载数据
input <- read.table("distribution_of_fragment_length_of_rep1i.tab", header=F)
data_vector <- rep(input$V1, input$V2)

# 2. 筛选数据范围：140-220 bp
selected_data <- data_vector[data_vector >= 140 & data_vector <= 220]

# 3. 拟合4成分高斯混合模型
library(mixtools)
set.seed(123)

# 尝试不同初始值，找到包含147附近峰值的拟合
best_fit <- NULL
best_dist <- Inf

cat("正在拟合4成分高斯混合模型...\n")
for(attempt in 1:20) {
  # 设置初始值：一个在147附近，其他随机
  initial_means <- c(147, 
                     147 + runif(1, 5, 15), 
                     147 - runif(1, 5, 15),
                     160 + runif(1, 10, 40))
  
  tryCatch({
    fit_temp <- normalmixEM(selected_data, 
                           k = 4, 
                           maxit = 2000,
                           epsilon = 1e-10)
    
    # 检查是否有成分在147附近（±3bp）
    dist_to_147 <- min(abs(fit_temp$mu - 147))
    if(dist_to_147 < best_dist) {
      best_fit <- fit_temp
      best_dist <- dist_to_147
      cat(sprintf("尝试 %d: 找到距离147bp %.2f 的成分\n", attempt, dist_to_147))
    }
  }, error = function(e) {})
}

if(is.null(best_fit)) {
  # 如果多次尝试失败，使用默认初始化
  cat("使用默认初始值...\n")
  fit <- normalmixEM(selected_data, k = 4, maxit = 2000, epsilon = 1e-10)
} else {
  fit <- best_fit
  cat(sprintf("\n最佳拟合: 距离147bp最近的成分相差 %.2f bp\n", best_dist))
}

# 4. 按均值排序成分，使输出更清晰
sorted_indices <- order(fit$mu)
sorted_mu <- fit$mu[sorted_indices]
sorted_sigma <- fit$sigma[sorted_indices]
sorted_lambda <- fit$lambda[sorted_indices]

# 5. 计算直方图信息
hist_info <- hist(selected_data, breaks=seq(140, 220, by=1), plot=FALSE)
max_density <- max(hist_info$density, na.rm=TRUE) * 1.3

# 6. 生成图片
png("rpe1i-gmm-k4.png", width=900, height=650)
par(mar=c(5,5,4,2)+0.1)

# 绘制直方图，binsize=1
hist(selected_data, breaks=seq(140, 220, by=1), freq=FALSE,
     main="RPE1i Fragment Length Distribution (140-220 bp) with 4-Component GMM",
     xlab="Fragment Length (bp)", ylab="Density",
     col=rgb(0.7, 0.85, 1, 0.6), border="white",
     xlim=c(140, 220),
     ylim=c(0, max_density))

# 添加四个高斯成分
colors <- c("red", "blue", "green", "orange")
x <- seq(140, 220, length=1000)

for(i in 1:4){
  idx <- sorted_indices[i]
  density_values <- sorted_lambda[i] * dnorm(x, sorted_mu[i], sorted_sigma[i])
  lines(x, density_values, col=colors[i], lwd=2.5)
  
  # 标记峰值位置
  peak_x <- sorted_mu[i]
  peak_y <- max(density_values)
  points(peak_x, peak_y, pch=19, col=colors[i], cex=1.5)
  
  # 添加峰值标签
  label_pos <- ifelse(i %% 2 == 0, 3, 1)  # 交替标签位置避免重叠
  text(peak_x, peak_y * (ifelse(label_pos == 3, 1.08, 0.92)), 
       paste0(round(peak_x, 1), " bp"), 
       col=colors[i], cex=0.85, pos=label_pos)
}

# 计算并绘制总混合密度
total_density <- rep(0, length(x))
for(i in 1:4) {
  total_density <- total_density + sorted_lambda[i] * dnorm(x, sorted_mu[i], sorted_sigma[i])
}
lines(x, total_density, col="black", lwd=2, lty=1)

# 添加原始数据的密度曲线作为对比
data_density <- density(selected_data, bw=0.8)
lines(data_density$x, data_density$y, col="purple", lwd=2.5, lty=2)

# 添加图例
legend("topright",
       c(paste("Component 1: ", round(sorted_mu[1],1), "bp (", round(sorted_lambda[1]*100,1), "%)"),
         paste("Component 2: ", round(sorted_mu[2],1), "bp (", round(sorted_lambda[2]*100,1), "%)"),
         paste("Component 3: ", round(sorted_mu[3],1), "bp (", round(sorted_lambda[3]*100,1), "%)"),
         paste("Component 4: ", round(sorted_mu[4],1), "bp (", round(sorted_lambda[4]*100,1), "%)"),
         "Gaussian Mixture",
         "Data Density (KDE)"),
       col=c(colors, "black", "purple"), 
       lwd=c(2.5,2.5,2.5,2.5,2,2.5), 
       lty=c(1,1,1,1,1,2),
       bg="white", cex=0.75)

# 添加网格
grid(col="gray", lty=3)

# 计算并显示拟合误差
x_density <- seq(140, 220, length=length(hist_info$density))
interp_total <- approx(x, total_density, xout=x_density)$y
fit_error <- sqrt(mean((interp_total - hist_info$density)^2, na.rm=TRUE))

# 在图上添加信息框
info_text <- c(
  sprintf("Data points: %d", length(selected_data)),
  sprintf("Components: 4"),
  sprintf("RMSE: %.4f", fit_error),
  sprintf("Near 147bp: Component %d (%.1f bp)", 
          which.min(abs(sorted_mu - 147)), 
          sorted_mu[which.min(abs(sorted_mu - 147))])
)

legend("topleft", info_text, bty="o", bg="white", cex=0.8, 
       box.col="gray", title="Model Info")

dev.off()

# 7. 输出详细结果
cat("\n=== 4成分高斯混合模型分析结果 ===\n")
cat("数据范围: 140-220 bp\n")
cat("数据点数:", length(selected_data), "\n")
cat("拟合均方根误差(RMSE):", round(fit_error, 4), "\n")
cat("\n各成分参数（按均值排序）:\n")
for(i in 1:4) {
  cat(sprintf("Component %d: 均值 = %.2f bp, 标准差 = %.2f, 比例 = %.1f%%\n",
              i, sorted_mu[i], sorted_sigma[i], sorted_lambda[i]*100))
}

# 检查147bp附近的成分
distances <- abs(sorted_mu - 147)
closest_idx <- which.min(distances)
cat("\n最接近147bp的成分: Component", closest_idx, "\n")
cat("该成分的峰值位置:", round(sorted_mu[closest_idx], 2), "bp\n")
cat("与147bp的距离:", round(distances[closest_idx], 2), "bp\n")

# 保存拟合结果
results <- list(
  data = selected_data,
  fit = fit,
  sorted_parameters = data.frame(
    component = 1:4,
    mean = sorted_mu,
    sd = sorted_sigma,
    proportion = sorted_lambda * 100
  ),
  fit_error = fit_error
)

save(results, file = "rpe1i-gmm-k4_results.RData")
cat("\n结果已保存到: rpe1i-gmm-k4_results.RData\n")
cat("图片已保存为: rpe1i-gmm-k4.png\n")
```